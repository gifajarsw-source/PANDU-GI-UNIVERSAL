<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PANDU-GI | Universal</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0284c7; --primary-dark: #0369a1; --bg: #f8fafc;
            --surface: #ffffff; --text-main: #0f172a; --text-sub: #64748b;
            --danger: #ef4444; --success: #22c55e; --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; }

        /* HEADER */
        .header { background: var(--surface); padding: 16px 20px; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-sm); border-bottom: 1px solid var(--border); }
        .app-brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .gi-name { font-size: 12px; background: #e0f2fe; color: var(--primary-dark); padding: 2px 8px; border-radius: 10px; margin-left: 5px; }
        .btn-back { display: none; background: #f1f5f9; border: none; padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 13px; color: var(--text-sub); cursor: pointer; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 90vh; }

        /* SETUP SCREEN (Untuk Aplikasi Kosong) */
        #setup-screen { display: none; text-align: center; padding-top: 40px; animation: fadeUp 0.5s ease; }
        .setup-icon { width: 80px; height: 80px; background: #e0f2fe; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .setup-box { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow-md); border: 1px solid var(--border); }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 10px; animation: fadeUp 0.4s ease; }
        .menu-card { background: var(--surface); border-radius: 20px; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: var(--shadow-md); border: 1px solid var(--border); cursor: pointer; transition: transform 0.1s; }
        .menu-card:active { transform: scale(0.96); background: #f8fafc; }
        .menu-icon-box { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 24px; }
        
        /* COLORS */
        .ic-blue { background: #e0f2fe; color: #0284c7; } .ic-green { background: #dcfce7; color: #16a34a; }
        .ic-orange { background: #ffedd5; color: #ea580c; } .ic-gray { background: #f1f5f9; color: #475569; }

        .menu-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; color: var(--text-main); }
        .menu-desc { font-size: 11px; color: var(--text-sub); }

        .app-section { display: none; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .app-section.active { display: block; }

        /* UI ELEMENTS */
        .card { background: var(--surface); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); position: relative; }
        .card.trip-alarm { border-left: 5px solid var(--danger); }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; background: #e0f2fe; color: var(--primary-dark); margin-bottom: 8px; }
        .card-title { font-size: 16px; font-weight: 700; margin: 0 0 8px 0; }
        .card-desc { font-size: 13px; color: var(--text-sub); margin: 0; line-height: 1.5; margin-bottom: 6px; }
        .card-label { font-weight: 600; font-size: 12px; color: var(--text-main); display: block; margin-top: 8px; }

        .btn { border: none; padding: 12px 16px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #f1f5f9; color: var(--text-main); border: 1px solid #cbd5e1; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-success { background: var(--success); color: white; }

        .delete-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #cbd5e1; cursor: pointer; padding: 5px; }
        .delete-btn:hover { color: var(--danger); }

        input[type="text"], input[type="number"], textarea, input[type="file"] { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; margin-bottom: 12px; font-size: 14px; }
        .search-bar { box-shadow: var(--shadow-sm); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: white; width: 100%; max-width: 450px; border-radius: 20px; padding: 24px; max-height: 85vh; overflow-y: auto; animation: slideUpModal 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUpModal { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">
    <div class="app-brand">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
        PANDU-GI <span id="gi-label" class="gi-name" style="display:none">UNIVERSAL</span>
    </div>
    <button id="btn-home" class="btn-back" onclick="goHome()">‚Üê Menu</button>
</div>

<div class="container">

    <div id="setup-screen">
        <div class="setup-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <h2 style="margin-bottom: 10px;">Selamat Datang!</h2>
        <p style="color:var(--text-sub); margin-bottom: 30px;">Aplikasi ini masih kosong. Silakan import file Database (.json) dari Admin Gardu Induk Anda.</p>
        
        <div class="setup-box">
            <h3 style="margin-top:0">Import Database GI</h3>
            <input type="file" id="setup-file" accept=".json">
            <button class="btn btn-primary" onclick="importDatabaseFirstTime()">üöÄ Mulai Gunakan Aplikasi</button>
            <p style="font-size:11px; color:#94a3b8; margin-top:15px">Belum punya file? Hubungi Admin atau buat manual.</p>
            <button class="btn btn-secondary" style="margin-top:5px; font-size:12px" onclick="createManual()">Buat Data Manual</button>
        </div>
    </div>

    <div id="main-menu" style="display:none;">
        <div style="margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 22px;">Halo, Operator üëã</h2>
            <p style="margin: 4px 0 0 0; color: var(--text-sub); font-size: 14px;">Operasional Gardu Induk <b id="gi-name-display">...</b></p>
        </div>

        <div class="menu-grid">
            <div class="menu-card" onclick="openSection('section-alarm')">
                <div class="menu-icon-box ic-blue"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></div>
                <div class="menu-title">Cari Alarm</div>
                <div class="menu-desc">Database Annunciator</div>
            </div>
            <div class="menu-card" onclick="openSection('section-sop')">
                <div class="menu-icon-box ic-green"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                <div class="menu-title">Dokumen SOP</div>
                <div class="menu-desc">Manual Book PDF</div>
            </div>
            <div class="menu-card" onclick="openSection('section-contact')">
                <div class="menu-icon-box ic-orange"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div>
                <div class="menu-title">Kontak</div>
                <div class="menu-desc">Nomor Darurat</div>
            </div>
            <div class="menu-card" onclick="openSection('section-data')">
                <div class="menu-icon-box ic-gray"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>
                <div class="menu-title">Data</div>
                <div class="menu-desc">Export / Import</div>
            </div>
        </div>
    </div>

    <div id="section-alarm" class="app-section">
        <input type="text" id="search-input" class="search-bar" placeholder="Ketik unit atau nama alarm..." oninput="renderAlarms()">
        <button class="btn btn-primary" style="margin-bottom:15px;" onclick="openModal('modal-alarm')">+ Tambah Data Alarm</button>
        <div id="alarm-list"></div>
    </div>

    <div id="section-sop" class="app-section">
        <h2 style="margin-top:0">Dokumen SOP</h2>
        <div class="card">
            <h3 class="card-title">Upload SOP (PDF)</h3>
            <p class="card-desc" style="margin-bottom:15px">SOP disimpan di memori HP masing-masing.</p>
            <input type="text" id="sop-name" placeholder="Nama Dokumen">
            <input type="file" id="sop-file" accept="application/pdf">
            <button class="btn btn-primary" onclick="addSOP()">Simpan Dokumen</button>
        </div>
        <h4 style="margin: 15px 0 10px 5px;">Daftar Dokumen</h4>
        <div id="sop-list"></div>
    </div>

    <div id="section-contact" class="app-section">
        <h2 style="margin-top:0">Kontak Darurat</h2>
        <button class="btn btn-primary" style="margin-bottom:15px;" onclick="openModal('modal-contact')">+ Tambah Kontak</button>
        <div id="contact-list"></div>
    </div>

    <div id="section-data" class="app-section">
        <h2 style="margin-top:0">Pengaturan Data</h2>
        
        <div class="card">
            <h3 class="card-title">Nama Gardu Induk</h3>
            <input type="text" id="in-gi-name" placeholder="Nama GI (Misal: CAWANG)" onchange="updateGIName()">
            <p class="card-desc">Ubah nama untuk ditampilkan di header.</p>
        </div>

        <div class="card">
            <h3 class="card-title">Bagikan Database</h3>
            <p class="card-desc" style="margin-bottom:15px">Kirim file ini ke operator lain agar data mereka sama.</p>
            <button class="btn btn-success" onclick="backupData()">üì§ Download File Database (.json)</button>
        </div>

        <div class="card" style="background:#fff1f2; border-color:#fecdd3;">
            <h3 class="card-title" style="color:#e11d48">Reset Aplikasi</h3>
            <p class="card-desc">Hapus semua data dan kembali ke mode awal.</p>
            <button class="btn btn-danger" style="margin-top:10px" onclick="clearAllData()">Hapus & Reset</button>
        </div>
    </div>
</div>

<div id="modal-alarm" class="overlay">
    <div class="modal">
        <h3 style="margin-top:0" id="modal-title-alarm">Tambah Data</h3>
        <input type="hidden" id="edit-idx">
        <input type="text" id="in-unit" placeholder="Unit (Contoh: TRAFO 1)">
        <input type="text" id="in-alarm" placeholder="Nama Alarm">
        <textarea id="in-maksud" rows="2" placeholder="Maksud Indikasi"></textarea>
        <textarea id="in-sebab" rows="2" placeholder="Penyebab"></textarea>
        <textarea id="in-tindakan" rows="2" placeholder="Tindakan"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn btn-primary" onclick="saveAlarm()">Simpan</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-alarm')">Batal</button>
        </div>
    </div>
</div>

<div id="modal-contact" class="overlay">
    <div class="modal">
        <h3 style="margin-top:0">Data Kontak</h3>
        <input type="hidden" id="contact-idx">
        <input type="text" id="in-nama" placeholder="Nama / Instansi">
        <input type="number" id="in-nomor" placeholder="Nomor Telepon">
        <div style="display:flex; gap:10px; margin-top:10px">
            <button class="btn btn-primary" onclick="saveContact()">Simpan</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-contact')">Batal</button>
        </div>
    </div>
</div>

<div id="loader"><div class="spinner"></div><div id="loader-text">Memproses...</div></div>

<script>
// --- LOGIKA UTAMA ---
let alarms = JSON.parse(localStorage.getItem('pandu_alarms')) || [];
let contacts = JSON.parse(localStorage.getItem('pandu_contacts')) || [];
let giName = localStorage.getItem('pandu_gi_name') || "";
let db;

// Cek apakah ini pengguna baru
checkFirstTime();

function checkFirstTime() {
    if (alarms.length === 0 && contacts.length === 0 && giName === "") {
        document.getElementById('setup-screen').style.display = 'block';
        document.getElementById('main-menu').style.display = 'none';
        document.querySelector('.header').style.display = 'none'; // Sembunyikan header saat setup
    } else {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('main-menu').style.display = 'block';
        document.querySelector('.header').style.display = 'flex';
        updateHeaderUI();
    }
}

function updateHeaderUI() {
    const lbl = document.getElementById('gi-label');
    const disp = document.getElementById('gi-name-display');
    const input = document.getElementById('in-gi-name');
    
    if(giName) {
        lbl.innerText = giName;
        lbl.style.display = 'inline-block';
        disp.innerText = giName;
        input.value = giName;
    } else {
        lbl.style.display = 'none';
        disp.innerText = "Universal";
    }
}

function createManual() {
    if(confirm("Mulai dengan database kosong?")) {
        giName = "UNIVERSAL";
        localStorage.setItem('pandu_gi_name', giName);
        location.reload();
    }
}

function updateGIName() {
    const val = document.getElementById('in-gi-name').value;
    if(val) {
        giName = val.toUpperCase();
        localStorage.setItem('pandu_gi_name', giName);
        updateHeaderUI();
        alert("Nama Gardu Induk diubah menjadi: " + giName);
    }
}

// --- IMPORT DATABASE PERTAMA KALI ---
function importDatabaseFirstTime() {
    const fileInput = document.getElementById('setup-file');
    if(fileInput.files.length === 0) { alert("Pilih file .json dulu!"); return; }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const d = JSON.parse(e.target.result);
            if(d.alarms || d.contacts) {
                alarms = d.alarms || [];
                contacts = d.contacts || [];
                giName = d.giName || "CUSTOM GI";
                
                localStorage.setItem('pandu_alarms', JSON.stringify(alarms));
                localStorage.setItem('pandu_contacts', JSON.stringify(contacts));
                localStorage.setItem('pandu_gi_name', giName);
                
                alert("Berhasil! Aplikasi siap digunakan untuk " + giName);
                location.reload();
            } else { alert("Format file salah."); }
        } catch(err) { alert("File error/corrupt."); }
    };
    reader.readAsText(fileInput.files[0]);
}

// --- NAVIGATION ---
function openSection(id) {
    document.getElementById('main-menu').style.display = 'none';
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('btn-home').style.display = 'block';
    if(id === 'section-alarm') {
        document.getElementById('search-input').focus();
        renderAlarms();
    } else if (id === 'section-contact') {
        renderContacts();
    }
}

function goHome() {
    document.getElementById('main-menu').style.display = 'block';
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.getElementById('btn-home').style.display = 'none';
}

// --- INDEXED DB (SOP) ---
const request = indexedDB.open("PanduGIDB", 1);
request.onupgradeneeded = function(e) {
    db = e.target.result;
    if (!db.objectStoreNames.contains('sops')) db.createObjectStore('sops', { keyPath: 'id', autoIncrement: true });
};
request.onsuccess = function(e) { db = e.target.result; renderSOPs(); };

function showLoader(show, text="Memproses...") {
    const l = document.getElementById('loader');
    document.getElementById('loader-text').innerText = text;
    l.style.display = show ? 'flex' : 'none';
}

// --- ALARM LOGIC ---
function renderAlarms() {
    const list = document.getElementById('alarm-list');
    const keyword = document.getElementById('search-input').value.toLowerCase();
    list.innerHTML = "";
    
    if(alarms.length === 0) {
        list.innerHTML = '<div class="empty-state">Database Alarm Kosong.<br>Silakan tambah manual atau import data.</div>';
        return;
    }

    const filtered = alarms.filter(item => item.s.toLowerCase().includes(keyword) || item.a.toLowerCase().includes(keyword));

    if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state">Tidak ditemukan.</div>';
        return;
    }

    filtered.forEach((item, index) => {
        const realIndex = alarms.indexOf(item);
        const isTrip = item.a.toLowerCase().includes('trip') || item.a.toLowerCase().includes('lockout');
        const borderClass = isTrip ? 'trip-alarm' : '';
        const html = `
            <div class="card ${borderClass}">
                <button class="delete-btn" onclick="deleteAlarm(${realIndex})">‚úï</button>
                <div class="badge">${item.s}</div>
                <h3 class="card-title" onclick="editAlarm(${realIndex})">${item.a}</h3>
                <span class="card-label">Indikasi:</span><p class="card-desc">${item.m}</p>
                <span class="card-label">Penyebab:</span><p class="card-desc">${item.p}</p>
                <span class="card-label">Tindakan:</span><p class="card-desc">${item.t}</p>
            </div>`;
        list.innerHTML += html;
    });
}
function openModal(id) {
    document.getElementById(id).style.display = 'flex';
    if(id === 'modal-alarm') {
        document.getElementById('modal-title-alarm').innerText = "Tambah Data";
        ['edit-idx','in-unit','in-alarm','in-maksud','in-sebab','in-tindakan'].forEach(i => document.getElementById(i).value = "");
    }
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function saveAlarm() {
    const idx = document.getElementById('edit-idx').value;
    const item = {
        s: document.getElementById('in-unit').value,
        a: document.getElementById('in-alarm').value,
        m: document.getElementById('in-maksud').value,
        p: document.getElementById('in-sebab').value,
        t: document.getElementById('in-tindakan').value
    };
    if(!item.s || !item.a) { alert("Unit dan Nama Alarm wajib diisi"); return; }
    if(idx === "") alarms.unshift(item); else alarms[idx] = item;
    localStorage.setItem('pandu_alarms', JSON.stringify(alarms));
    closeModal('modal-alarm'); renderAlarms();
}
function editAlarm(i) {
    const item = alarms[i];
    document.getElementById('edit-idx').value = i;
    document.getElementById('in-unit').value = item.s;
    document.getElementById('in-alarm').value = item.a;
    document.getElementById('in-maksud').value = item.m;
    document.getElementById('in-sebab').value = item.p;
    document.getElementById('in-tindakan').value = item.t;
    document.getElementById('modal-title-alarm').innerText = "Edit Data";
    openModal('modal-alarm');
}
function deleteAlarm(i) {
    if(confirm("Hapus alarm ini?")) {
        alarms.splice(i, 1);
        localStorage.setItem('pandu_alarms', JSON.stringify(alarms));
        renderAlarms();
    }
}

// --- SOP LOGIC ---
function addSOP() {
    const f = document.getElementById('sop-file');
    const n = document.getElementById('sop-name');
    if (f.files.length === 0 || !n.value) { alert("Isi nama dan pilih file."); return; }
    showLoader(true, "Menyimpan...");
    const r = new FileReader();
    r.onload = function(e) {
        const b = new Blob([e.target.result], { type: 'application/pdf' });
        const tx = db.transaction(['sops'], 'readwrite');
        tx.objectStore('sops').add({ name: n.value, blob: b, date: new Date().toLocaleDateString() });
        tx.oncomplete = function() { showLoader(false); n.value=""; f.value=""; renderSOPs(); alert("SOP tersimpan!"); };
        tx.onerror = function() { showLoader(false); alert("Gagal simpan (File terlalu besar?)"); };
    };
    r.readAsArrayBuffer(f.files[0]);
}
function renderSOPs() {
    const l = document.getElementById('sop-list');
    l.innerHTML = "<div class='spinner' style='width:20px;height:20px;border-width:2px;border-top-color:var(--primary)'></div>";
    const req = db.transaction(['sops'], 'readonly').objectStore('sops').getAll();
    req.onsuccess = function(e) {
        const fs = e.target.result;
        l.innerHTML = fs.length ? "" : "<p class='card-desc'>Belum ada dokumen.</p>";
        fs.forEach(f => {
            const u = URL.createObjectURL(f.blob);
            l.innerHTML += `<div class="card" style="display:flex;justify-content:space-between;align-items:center;"><div><h4 class="card-title" style="margin-bottom:4px">${f.name}</h4><span class="card-desc">${f.date}</span></div><div style="display:flex;gap:8px"><a href="${u}" target="_blank" class="btn btn-secondary" style="padding:8px 12px">Buka</a><button class="btn btn-danger" style="padding:8px" onclick="deleteSOP(${f.id})">üóëÔ∏è</button></div></div>`;
        });
    };
}
function deleteSOP(id) {
    if(confirm("Hapus SOP?")) {
        const tx = db.transaction(['sops'], 'readwrite');
        tx.objectStore('sops').delete(id);
        tx.oncomplete = () => renderSOPs();
    }
}

// --- CONTACTS ---
function renderContacts() {
    const l = document.getElementById('contact-list'); l.innerHTML = "";
    if(contacts.length === 0) { l.innerHTML = "<div class='empty-state'>Belum ada kontak.</div>"; return; }
    contacts.forEach((c, i) => {
        l.innerHTML += `<div class="card" style="display:flex;justify-content:space-between;align-items:center;"><div><h4 class="card-title" style="margin-bottom:4px">${c.nama}</h4><a href="tel:${c.no}" class="card-desc" style="color:var(--primary);font-weight:700;text-decoration:none">${c.no}</a></div><button class="btn btn-danger" style="padding:8px" onclick="deleteContact(${i})">üóëÔ∏è</button></div>`;
    });
}
function saveContact() {
    const n = document.getElementById('in-nama').value;
    const no = document.getElementById('in-nomor').value;
    if(!n || !no) return;
    contacts.push({nama:n, no:no});
    localStorage.setItem('pandu_contacts', JSON.stringify(contacts));
    closeModal('modal-contact'); renderContacts();
    document.getElementById('in-nama').value=""; document.getElementById('in-nomor').value="";
}
function deleteContact(i) {
    if(confirm("Hapus kontak?")) {
        contacts.splice(i, 1);
        localStorage.setItem('pandu_contacts', JSON.stringify(contacts));
        renderContacts();
    }
}

// --- BACKUP RESTORE (EXPORT/IMPORT) ---
function backupData() {
    const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ 
        alarms: alarms, 
        contacts: contacts,
        giName: giName,
        version: "2.0" 
    }));
    const a = document.createElement('a');
    a.href = d; 
    a.download = "PANDU_GI_" + (giName ? giName.replace(" ", "_") : "DATA") + "_" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a); a.click(); a.remove();
}

function clearAllData() {
    if(confirm("PERINGATAN: Semua data akan dihapus dan aplikasi kembali kosong. Lanjutkan?")) {
        localStorage.clear();
        const req = indexedDB.deleteDatabase("PanduGIDB");
        req.onsuccess = function() { location.reload(); };
    }
}
</script>
</body>
</html>
